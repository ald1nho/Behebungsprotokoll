<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Behebungsprotokoll</title>
    <link rel="stylesheet" data-hf-href="behebungsprotokoll.css">
    <!-- Load helper for both HF runtime (data-hf-src) and plain browser (src) -->
    <script src="BehebungsprotokollHelper.js" data-hf-src="BehebungsprotokollHelper.js" defer></script>
</head>
<body>
    <form>
        <!-- Template Variables -->
        <var data-hf-name="info"
            data-hf-version="1.0.0"
            data-hf-date="2025-09-02T12:00:00.000Z"
            data-hf-min-app-version="10.0.0"
            data-hf-min-server-version="10.0.0">
        </var>
        <var data-hf-name="Title">Behebungsprotokoll</var>
        
        <!-- Define namespace for BehebungsprotokollHelper -->
        <script type="text/javascript">
            console.log('=== Behebungsprotokoll HTML geladen ===');
            
            // Ensure namespace exists
            if (!window.HFFormdefinition) {
                window.HFFormdefinition = {};
            }
            if (!window.HFFormdefinition.BehebungsprotokollHelper) {
                window.HFFormdefinition.BehebungsprotokollHelper = {};
            }

            // Debug script to check if functions are available
            console.log('=== Behebungsprotokoll initialisiert ===');
        </script>
        
        <!-- FormDev Catalog Includes -->
        <var data-hf-name="FormDevCatalogIncludes"
            data-hf-catalogs='[
                {"name": "Bezirke", "catalog": "catalog.Bezirke.json"},
                {"name": "Katastrophenarten", "catalog": "catalog.Katastrophenarten.json"},
                {"name": "Straßenmeistereien", "catalog": "catalog.Straßenmeistereien.json"}
            ]'>
        </var>

        <!-- Navigation: Pages > Tabs > Blocks -->
        <ol>
            <!-- Page 1: Grunddaten -->
            <li data-hf-title="Grunddaten" id="page-grunddaten">
                <ol>
                    <li data-hf-title="Allgemeine Angaben" id="tab-grunddaten">
                        <a href="#block-grunddaten-1"></a>
                        <a href="#block-grunddaten-2"></a>
                    </li>
                </ol>
            </li>

            <!-- Page 2: Beschreibung -->
            <li data-hf-title="Schadensbeschreibung" id="page-beschreibung">
                <ol>
                    <li data-hf-title="Details" id="tab-beschreibung">
                        <a href="#block-beschreibung-1"></a>
                        <a href="#block-beschreibung-2"></a>
                    </li>
                </ol>
            </li>

            <!-- Page 3: Leistungen -->
            <li data-hf-title="Leistungen" id="page-leistungen">
                <ol>
                    <!-- Eigenleistungen als Repeating Unit (2. Ebene) -->
                    <li data-hf-title="Eigenleistungen"
                        id="tab_eigenleistungen"
                        data-hf-repeating='{
                            "min": 1,
                            "label": "Eigenleistung",
                            "labelAdd": "Eigenleistung hinzufügen",
                            "labelRemove": "Entfernen",
                            "anchors": false,
                            "toolbar": true
                        }'>
                        <a href="#eigenleistungen-block1" data-hf-fullwidth="true"></a>
                    </li>
                    
                    <!-- Fremdleistungen als Repeating Unit (2. Ebene) -->
                    <li data-hf-title="Fremdleistungen"
                        id="tab_fremdleistungen"
                        data-hf-repeating='{
                            "min": 1,
                            "label": "Fremdleistung",
                            "labelAdd": "Fremdleistung hinzufügen",
                            "labelRemove": "Entfernen",
                            "anchors": false,
                            "toolbar": true
                        }'>
                        <a href="#fremdleistungen-block1" data-hf-fullwidth="true"></a>
                    </li>

                    <!-- Summen / Zusammenfassung (nicht wiederholbar) -->
                    <li data-hf-title="Zusammenfassung" id="tab_leistungen_sum">
                        <a href="#block-leistungen-fremd"></a>
                    </li>
                </ol>
            </li>

            <!-- Page 4: Abschluss -->
            <li data-hf-title="Abschluss" id="page-abschluss">
                <ol>
                    <li data-hf-title="Signatur" id="tab-signatur">
                        <a href="#block-signatur"></a>
                        <a href="#block-approve"></a>
                    </li>
                </ol>
            </li>
        </ol>
    </form>

    <!-- Header Templates -->
    <div id="titleTemplate"
        data-win-control="WinJS.Binding.Template">
        <h3 data-win-control="HFWinJSCtrl.Spacer">
            <span>Behebungsprotokoll - Katastrophenschäden</span>
            <span class="spacer">|</span>
            <span data-win-control="HFWinJSCtrl.ObserveField"
                data-win-options="{
                    fieldId: 'gemeinde'
                }"></span>
            <span class="spacer">|</span>
            <span data-win-control="HFWinJSCtrl.ObserveField"
                data-win-options="{
                    fieldId: 'strasse'
                }"></span>
            <span class="spacer">|</span>
            <span data-win-control="HFWinJSCtrl.ObserveField"
                data-win-options="{
                    fieldId: 'schadensdatum'
                }"></span>
        </h3>
    </div>

    <div id="listTemplate"
        data-win-control="WinJS.Binding.Template"
        data-win-options="{
            img: 'behebungsprotokoll.png',
            showMainImage: true
        }">

        <div class="row-1">
            <h3>
                <span data-win-control="HFWinJSCtrl.Spacer">
                    <span data-win-bind="textContent: listData.schadensdatum"
                        data-win-control="HFWinJSCtrl.DateFormater"
                        data-win-options="{
                            dateFormat: 'dd.MM.yyyy',
                            dateOnly: true
                        }"></span>
                    <span class="spacer"> | </span>
                    <span data-win-bind="textContent: listData.lfd_nr"></span>
                </span>
            </h3>
        </div>

        <div class="row-2">
            <h4 data-win-control="HFWinJSCtrl.Spacer">
                <span data-win-control="HFWinJSCtrl.Spacer">
                    <span data-win-bind="textContent:listData.strasse"></span>
                    <span class="spacer"> | </span>
                    <span>Kilometer:</span>
                    <span data-win-bind="textContent:listData.kilometer"></span>
                </span>
            </h4>
        </div>

        <div class="row-3">
            <h5 data-win-control="HFWinJSCtrl.Spacer">
                <strong>Schadensart: </strong>
                <span data-win-bind="textContent: listData.art_katastrophe"></span>
            </h5>
        </div>
    </div>

    <!-- Block Definitionen -->
    
    <!-- Grunddaten Block: Alle Angaben -->
    <!-- Block 1: linke Spalte -->
<div id="block-grunddaten-1"
     data-hf-block
     data-hf-title="Allgemeine Angaben – Teil 1"
     data-hf-columns="12">
  <div data-hf-row><div data-hf-column="12">
    <!-- Lfd. Nr. -->
    <input id="lfd_nr"
           type="text"
           data-hf-control="TextField"
           data-hf-options='{
             "label": "Lfd. Nr.",
             "placeholder": "z. B. 001",
             "required": true,
             "list": true,
             "validator": {
               "pattern": "^[0-9A-Za-z/-]+$",
               "errorText": "Bitte nur Ziffern, Buchstaben sowie - oder / verwenden."
             }
           }'>
  </div></div>
  <div data-hf-row><div data-hf-column="12">
    <!-- Gemeinde -->
    <input id="gemeinde"
           type="text"
           data-hf-control="TextField"
           data-hf-options='{
             "label": "Gemeinde",
             "placeholder": "Gemeindename",
             "required": true
           }'>
  </div></div>
  <div data-hf-row><div data-hf-column="12">
    <!-- Bezirk -->
    <div id="bezirk"
         data-hf-control="ComboBox"
         data-hf-options='{
           "label": "Bezirk",
           "url": "/api/catalogs/Bezirke",
           "dataTextField": "Name",
           "dataValueField": "ID",
           "placeholder": "Bezirk wählen...",
           "required": true
         }'></div>
  </div></div>
  <div data-hf-row><div data-hf-column="12">
    <!-- Art Katastrophe -->
    <div id="art_katastrophe"
         data-hf-control="ComboBox"
         data-hf-options='{
           "label": "Art der Katastrophe",
           "url": "/api/catalogs/Katastrophenarten",
           "dataTextField": "Name",
           "dataValueField": "Name",
           "placeholder": "Katastrophenart wählen...",
           "required": true,
           "list": true
         }'></div>
  </div></div>
  <div data-hf-row><div data-hf-column="12">
    <!-- Straßenmeisterei -->
    <div id="strassenmeisterei"
         data-hf-control="ComboBox"
         data-hf-options='{
           "label": "Straßenmeisterei",
           "url": "/api/catalogs/Straßenmeistereien",
           "dataTextField": "Name",
           "dataValueField": "ID",
           "placeholder": "Straßenmeisterei wählen...",
           "required": true
         }'></div>
  </div></div>
  <div data-hf-row><div data-hf-column="12">
    <!-- Straße -->
     <input id="strasse"
           type="text"
           data-hf-control="TextField"
          data-hf-options='{
            "label": "Straße",
            "placeholder": "Straßenname",
            "required": true,
            "list": true
           }'>
  </div></div>
  <div data-hf-row><div data-hf-column="12">
    <!-- Kilometer -->
    <div id="kilometer"
         data-hf-control="NumericField"
         data-hf-options='{
           "label": "Kilometer",
           "step": 1,
           "min": 0,
           "placeholder": "z. B. 12.3",
           "required": true,
           "format": "0.000",
           "decimals": 3,
           "list": true
         }'></div>
  </div></div>
</div>

<!-- Block 2: rechte Spalte -->
<div id="block-grunddaten-2"
     data-hf-block
     data-hf-title="Allgemeine Angaben – Teil 2"
     data-hf-columns="12">
  <div data-hf-row><div data-hf-column="12">
    <!-- Schadensdatum -->
    <div id="schadensdatum"
         data-hf-control="DatePicker"
         data-hf-options='{
           "label": "Schadensdatum von",
           "required": true,
           "defaultValue": "now",
           "emptyContent": "Datum wählen...",
           "displayValueFormat": "dd.MM.yyyy",
           "parseFormats": ["dd.MM.yyyy", "ddMMyyyy", "dd/MM/yyyy", "dd-MM-yyyy"],
           "list": true
         }'></div>
  </div></div>
  <div data-hf-row><div data-hf-column="12">
    <!-- Schadensdatum -->
    <div id="schadensdatum-2"
         data-hf-control="DatePicker"
         data-hf-options='{
           "label": "Schadensdatum bis",
           "required": true,
           "defaultValue": "now",
           "emptyContent": "Datum wählen...",
           "displayValueFormat": "dd.MM.yyyy",
           "parseFormats": ["dd.MM.yyyy", "ddMMyyyy", "dd/MM/yyyy", "dd-MM-yyyy"]
         }'></div>
  </div></div>
  <div data-hf-row><div data-hf-column="12">
    <!-- Wiederherstellung -->
    <div id="wiederherstellung"
         data-hf-control="DatePicker"
         data-hf-options='{
           "label": "Wiederherstellung von",
           "required": true,
           "defaultValue": "now",
           "emptyContent": "Datum wählen...",
           "displayValueFormat": "dd.MM.yyyy",
           "parseFormats": ["dd.MM.yyyy", "ddMMyyyy", "dd/MM/yyyy", "dd-MM-yyyy"]
         }'></div>
  </div></div>
  <div data-hf-row><div data-hf-column="12">
    <!-- Wiederherstellung -->
    <div id="wiederherstellung-2"
         data-hf-control="DatePicker"
         data-hf-options='{
           "label": "Wiederherstellung bis",
           "required": true,
           "defaultValue": "now",
           "emptyContent": "Datum wählen...",
           "displayValueFormat": "dd.MM.yyyy",
           "parseFormats": ["dd.MM.yyyy", "ddMMyyyy", "dd/MM/yyyy", "dd-MM-yyyy"]
         }'></div>
  </div></div>
</div>

    <!-- Beschreibung Block 1: Schadensbeschreibung -->
    <div data-hf-block 
         data-hf-columns="12" 
         data-hf-title="Schadensbeschreibung"
         id="block-beschreibung-1">
        
        <div data-hf-row>
            <div data-hf-column="12">
                <textarea id="schadens_beschreibung"
                          rows="10"
                          style="min-height: 240px;"
                          data-hf-control="TextField"
                          data-hf-options='{
                              "label": "Beschreibung des Schadens",
                              "required": true,
                              "placeholder": "Detaillierte Beschreibung des Schadens eingeben...",
                              "multiline": true,
                              "autoResize": true
                          }'></textarea>
            </div>
        </div>

        
    </div>

    <!-- Beschreibung Block 2: Dokumentation -->
    <div data-hf-block 
         data-hf-columns="12" 
         data-hf-title="Dokumentation"
         id="block-beschreibung-2">
        
        <div data-hf-row>
            <div data-hf-column="12">
                <div id="photo_documentation"
                     data-hf-control="PicturePicker"
                     data-hf-options="{
                         label: 'Foto-Dokumentation',
                         multiple: true,
                         required: false
                     }">
                </div>
            </div>
        </div>

        <div data-hf-row>
            <div data-hf-column="12">
                <div id="document_upload"
                     data-hf-control="FileUploader"
                     data-hf-options='{
                         "label": "Dokumente hochladen",
                         "required": false,
                         "allowedFormats": ["pdf", "doc", "docx", "xls", "xlsx", "ppt", "pptx"],
                         "maxFileUploads": 10,
                         "descriptionStart": "Zusätzliche Dokumente oder Berichte hochladen.",
                         "buttonLabel": "Dokument hinzufügen"
                     }'>
                </div>
            </div>
        </div>

        <div data-hf-row>
            <div data-hf-column="6">
                <input type="checkbox" 
                       id="beilage_fotos" 
                       value="fotos"
                       data-hf-control="CheckBox"
                       data-hf-options="{
                           label: 'Fotos (ab 1.500 €)'
                       }">
            </div>
            <div data-hf-column="6">
                <input type="checkbox" 
                       id="beilage_rechnungen" 
                       value="rechnungen"
                       data-hf-control="CheckBox"
                       data-hf-options="{
                           label: 'Rechnungen extern'
                       }">
            </div>
        </div>
    </div>

    <!-- Leistungen: Block 1 - Eigenleistungen mit data-hf-repeatable -->
   
    <!-- Template: Eigenleistungen (eine Zeile) - 1:1 Copy from Spare Parts -->
    <div id="eigenleistungen-block1"
        data-hf-template
        data-hf-repeatable="tab_eigenleistungen"
        data-hf-repeatableoptions='{
            "minItems": 1,
            "maxItems": 50,
            "addButtonText": "Eigenleistung hinzufügen",
            "removeButtonText": "Entfernen"
        }'>
        <div class="grid column3">
            <div class="r1 c1 cspan2 get-row-combo">
                <div class="grid column3">
                    <div class="r1 c1">
                        <input type="text"
                            id="eigenleistung_index"
                            data-hf-control="TextField"
                            data-hf-options='{"label":"#","disabled":true,"defaultValue":"1"}' />
                    </div>
                    <div class="r1 c2">
                        <input type="text"
                            id="eigenleistung_bezeichnung"
                            data-hf-control="TextField"
                            data-hf-options='{"label":"Bezeichnung Eigenleistung","placeholder":"Bezeichnung eingeben"}' />
                    </div>
                    <div class="r1 c3">
                        <input type="number"
                            id="eigenleistung_menge"
                            data-hf-control="NumericField"
                            data-hf-options='{
                                "label":"Menge",
                                "step":0.01,
                                "min":0,
                                "placeholder":"Menge"
                            }'
                            data-hf-onchanged="HFFormdefinition.BehebungsprotokollHelper.calculateEigenleistungRowRepeatable" />
                    </div>
                </div>
            </div>
            <div class="r1 c3">
                <div class="grid column3">
                    <div class="r1 c1">
                        <select id="eigenleistung_einheit"
                            data-hf-control="DropDownList"
                            data-hf-options='{"label":"Einheit"}'>
                            <option value="Std.">Std.</option>
                            <option value="Stk.">Stk.</option>
                            <option value="m">m</option>
                            <option value="m²">m²</option>
                            <option value="m³">m³</option>
                            <option value="kg">kg</option>
                            <option value="t">t</option>
                        </select>
                    </div>
                    <div class="r1 c2">
                        <input type="number"
                            id="eigenleistung_ep"
                            data-hf-control="NumericField"
                            data-hf-options='{
                                "label":"EP",
                                "step":0.01,
                                "min":0,
                                "placeholder":"Einzelpreis"
                            }'
                            data-hf-onchanged="HFFormdefinition.BehebungsprotokollHelper.calculateEigenleistungRowRepeatable" />
                    </div>
                    <div class="r1 c3">
                        <input type="text"
                            id="eigenleistung_summe"
                            data-hf-control="TextField"
                            data-hf-options='{"label":"Summe in €","disabled":true,"defaultValue":"0.00"}' />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Template: Fremdleistungen (eine Zeile) -->
    <div id="fremdleistungen-block1"
        data-hf-template
        data-hf-repeatable="tab_fremdleistungen"
        data-hf-repeatableoptions='{
            "minItems": 1,
            "maxItems": 50,
            "addButtonText": "Fremdleistung hinzufügen",
            "removeButtonText": "Entfernen"
        }'>
        <div class="grid column3">
            <div class="r1 c1 cspan2 get-row-combo">
                <div class="grid column2">
                    <div class="r1 c1">
                        <input type="text"
                            id="fremdleistung_index"
                            data-hf-control="TextField"
                            data-hf-options='{"label":"#","disabled":true,"defaultValue":"1"}' />
                    </div>
                    <div class="r1 c2">
                        <input type="text"
                            id="fremdleistung_bezeichnung"
                            data-hf-control="TextField"
                            data-hf-options='{"label":"Bezeichnung Fremdleistung","placeholder":"Bezeichnung eingeben"}' />
                    </div>
                </div>
            </div>
            <div class="r1 c3">
                <div class="grid column2">
                    <div class="r1 c1">
                        <input type="text"
                            id="fremdleistung_rechnung"
                            data-hf-control="TextField"
                            data-hf-options='{"label":"Rechnung","placeholder":"Rechnungsnummer"}' />
                    </div>
                    <div class="r1 c2">
                        <input type="number"
                            id="fremdleistung_summe"
                            data-hf-control="NumericField"
                            data-hf-options='{
                                "label":"Summe in €",
                                "step":0.01,
                                "min":0,
                                "placeholder":"Summe Netto"
                            }'
                            data-hf-onchanged="HFFormdefinition.BehebungsprotokollHelper.calculateFremdleistungTotalRepeatable" />
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Entfernt: alter Fremdleistungen-Block (nun Tab-basiert) -->

    <!-- Leistungen: Block 2 - Zusammenfassung -->
    <div data-hf-block
         data-hf-columns="12"
         data-hf-title="Zusammenfassung"
         id="block-leistungen-fremd">
        
        <!-- Summe Eigenleistungen -->
        <div data-hf-row>
            <div data-hf-column="12">
                <div style="margin: 20px 0; padding: 6px; border: 2px solid #ddd; background-color: #f9f9f9;">
                    <input type="text" 
                           id="summe_eigenleistungen"
                           data-hf-control="TextField"
                           data-hf-options='{"label":"Summe Eigenleistungen in €","disabled":true,"defaultValue":"0.00"}'
                           style="width: 200px; padding: 6px; font-size: 16px; font-weight: bold; background-color: #fff; border: 1px solid #ccc;">
                </div>
            </div>
        </div>

        <!-- Summen Fremdleistungen (Netto/MwSt/Brutto) -->
        <div data-hf-row>
            <div data-hf-column="4">
                <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; background-color: #f9f9f9;">
                    <input type="text" 
                           id="summe_fremdleistungen_netto"
                           data-hf-control="TextField"
                           data-hf-options='{"label":"Summe Fremdleistungen netto","disabled":true,"defaultValue":"0.00"}'
                           style="width: 100%; padding: 8px; font-weight: bold; background-color: #fff; border: 1px solid #ccc;">
                </div>
            </div>
            <div data-hf-column="4">
                <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; background-color: #f9f9f9;">
                    <input type="text" 
                           id="mwst_fremdleistungen"
                           data-hf-control="TextField"
                           data-hf-options='{"label":"MwSt (20%)","disabled":true,"defaultValue":"0.00"}'
                           style="width: 100%; padding: 8px; font-weight: bold; background-color: #fff; border: 1px solid #ccc;">
                </div>
            </div>
            <div data-hf-column="4">
                <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; background-color: #f9f9f9;">
                    <input type="text" 
                           id="summe_fremdleistungen_brutto"
                           data-hf-control="TextField"
                           data-hf-options='{"label":"Summe Fremdleistungen brutto","disabled":true,"defaultValue":"0.00"}'
                           style="width: 100%; padding: 8px; font-weight: bold; background-color: #fff; border: 1px solid #ccc;">
                </div>
            </div>
        </div>
        <div data-hf-row>
            <div data-hf-column="4">
                <div style="margin: 20px 0; padding: 15px; border: 2px solid #007bff; background-color: #e7f1ff;">
                    <input type="text" 
                           id="summary_eigenleistung"
                           data-hf-control="TextField"
                           data-hf-options='{"label":"Eigenleistung in €","disabled":true,"defaultValue":"0.00"}'
                           style="width: 100%; padding: 10px; font-size: 16px; font-weight: bold; background-color: #fff; border: 1px solid #007bff;">
                </div>
            </div>
            <div data-hf-column="4">
                <div style="margin: 20px 0; padding: 15px; border: 2px solid #007bff; background-color: #e7f1ff;">
                    <input type="text" 
                           id="summary_fremdleistung"
                           data-hf-control="TextField"
                           data-hf-options='{"label":"Fremdleistung in €","disabled":true,"defaultValue":"0.00"}'
                           style="width: 100%; padding: 10px; font-size: 16px; font-weight: bold; background-color: #fff; border: 1px solid #007bff;">
                </div>
            </div>
            <div data-hf-column="4">
                <div style="margin: 20px 0; padding: 15px; border: 3px solid #28a745; background-color: #d4edda;">
                    <input type="text" 
                           id="summary_gesamt"
                           data-hf-control="TextField"
                           data-hf-options='{"label":"GESAMT in €","disabled":true,"defaultValue":"0.00"}'
                           style="width: 100%; padding: 12px; font-size: 18px; font-weight: bold; background-color: #fff; border: 2px solid #28a745; color: #28a745;">
                </div>
            </div>
        </div>
    </div>

    <!-- Signatur Block -->
    <div data-hf-block 
         data-hf-columns="12" 
         data-hf-title="Digitale Signatur"
         id="block-signatur">
        
        <div data-hf-row>
            <div data-hf-column="12">
                <p>Durch Ihre Unterschrift bestätigen Sie die Richtigkeit und Vollständigkeit der Angaben.</p>
            </div>
        </div>

        <div data-hf-row>
            <div data-hf-column="12">
                <div id="signatur"
                     data-hf-control="Signature"
                     data-hf-options="{
                         label: 'Digitale Signatur',
                         required: true,
                         tooltip: 'Bitte hier unterschreiben!',
                         clearButton: true,
                         saveTimeout: 10,
                         openInOverlay: {
                             type: 'mobile',
                             rotateToLandscape: true
                         },
                         printMetadata: true,
                         printMetadataParts: ['Location','Signer','ItemID','DateTime'],
                         forceUnsafe: true
                     }">
                </div>
            </div>
        </div>
    </div>

    <!-- Approve Block -->
    <div data-hf-block 
         data-hf-columns="12" 
         data-hf-title="Formular abschließen"
         id="block-approve">
        
        <div data-hf-row>
            <div data-hf-column="12">
                <div id="approve_button"
                     data-hf-control="ApproveButton"
                     data-hf-options="{
                         action: 'GoTo_ListApproved',
                         buttonType: 'large',
                         buttonHeading: 'Protokoll abschließen',
                         buttonLabel: 'Abschließen',
                         confirmDialogTitle: 'Protokoll abschließen?',
                         confirmDialogMessage: 'Möchten Sie das Behebungsprotokoll wirklich abschließen?'
                     }">
                </div>
            </div>
        </div>
    </div>

</body>
</html>
